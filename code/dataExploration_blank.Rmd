---
title: "TCIA Data Exploration"
author: "Grant Carr"
date: "`r Sys.Date()`"
output: pdf_document
---

## R Setup

Load packages that are necessary for running all code below.
```{r}
#' example code for installing packages for first time:
#' install.packages("readxl")


library(readxl)
library(tidyverse)
library(ggplot2)
library(survival)
library(ggfortify)
library(devtools)
```


## Reading Clinical Data


```{r}
clinData <- read_xlsx(
  "/Users/grantcarr/Documents/Michigan/BDSI2025/Data/Clinical_and_Other_Features.xlsx", 
  sheet = 1, skip = 1
)
clinData <- clinData[-1,]
```
The '<-' is the assignment operator in R. clinData <- read_xlsx(...) assigns 
the output of read_xlsx() into a variable/object called clinData. Keyboard 
shortcut on a Mac is option, -. You can also use '='. '<-' is used to differentiate 
setting function arguments versus assigning data to a variable.

If you open the dataset, you will see that the first row is variable group 
headings. We want to skip that row when we read the data with the function 
argument "skip = 1".

The second row is treated as the column names and the third row is treated as 
data. In excel, the third row is variable descriptions, not data. So we remove 
the first row with clinData[-1,]. When you are working with 2-dimensional 
datasets/matrix objects, you access rows/columns with clinData[rows, columns]. 
You can pass a vector of numbers to select (or negative numbers to select 
everything except) specific rows/columns of the data.

## Changing Column Names

In the output above, you can see that R changed blank column names to
"...[column number]", and duplicated column names to "[column name]...[column 
number]". Below I manually changed the names of those blank/duplicated column 
names into descriptive column names based on the variable descriptions in 
the excel file.

```{r}
clinData <- clinData %>% rename(
  TumorGradeT = `Tumor Grade`,
  TumorGradeN = ...33,
  TumorGradeM = ...34,
  DiffBilateralReceptors = ...40,
  AnnotatedBilateralSide = ...41,
  OtherBilateralSide = `For Other Side If Bilateral`,
  OtherBilateralOncotype = ...43,
  OtherBilateralGrade = ...44,
  OtherBilateralER = ...45,
  OtherBilateralPR = ...46,
  OtherBilateralHER2 = ...47,
  OtherBilateralSubtype = ...48,
  Shape_mammo = Shape...71,
  Margin_mammo = Margin...72,
  TumorSize_mammo = `Tumor Size (cm)...76`,
  
  Shape_us = Shape...77,
  Margin_us = Margin...78,
  TumorSize_us = `Tumor Size (cm)...79`
) %>% select(-...68)
```

The %>% operator (command, shift, m shortcut on Mac) is from the dplyr package
and means "use the output on the left side as the first argument of the
function on the right". It is useful for sequentially performing multiple 
functions in a single line of code, especially for data formatting.
"select(-...68)" again means that we select every column except for the one 
named "...68".

```{r}
table(clinData$AnnotatedBilateralSide, useNA = "if")
table(clinData$Shape_us, useNA = "if")
table(clinData$`Reconstruction Diameter`, useNA = "if")
```

Tabulating the possible values of the example variables above, we see the labels
"NA", "NC", and "NP". Note that "NA" is the letters "NA", not R's value for NA.
This means that R is treating it as data instead of missing. 

From the excel file, NA means not applicable, NC means not collected, and NP 
means not pertinent. All of these indicate that we don't have the relevant data
for that patient.

Depending on the variable, we may or may not wish to replace "NC" or "NP" with
a missing value, but this is something to keep in mind.

## Reading Image Features
```{r}
imFeatures <- read_xlsx(
  "/Users/grantcarr/Documents/Michigan/BDSI2025/Data/Imaging_Features.xlsx",
  sheet = 1
)
```

In general, the featureCitations.docx file describes the features and provides 
citations. The features are grouped into the categories listed below.

Breast and fibroglandular tissue (FGT) volume features: volume and density of 
breast area and fibroglandular area.

Tumor size and morphology: regularity/roundness vs irregularity of tumor
shape and size.

FGT enhancement: measure how much FGT is enhanced when we add contrast.
This is referred to as BPE, background parenchymal enhancement, which may 
confound tumor enhancement/identification.

Tumor enhancement: measure how much tumor is enhanced when we add contrast

Combining tumor and FGT enhancement: measure how tumor and FGT are 
enhanced when adding contrast

FGT enhancement texture: describe the enhancement due to contrast. Looking at
local patterns, does enhancement look gritty or smooth?

Tumor enhancement texture: same as FGT but for tumor area.

Tumor Enhancement Spatial Heterogeneity: measure similarity between tumor
subregions of the tumor.

FGT enhancement variation: global variation of contrast enhancement of FGT

Tumor enhancement variation: global variation of contrast enhancement of tumor

## Task 1: What is in the data?

How many patients are in the dataset?


How many missing values are there among image features?


How many missing values are there among clinical features?


## Task 2: Visualizing Data

Tabulate/plot some clinical variables. Take note of any abnormalities such as 
missingness, low data in a category, or significant skew in continuous 
variables.

Pick a group of image features as they are grouped in the 
featureDocumentation.docx file. Explore whether there is an association between 
the image feature(s) and any clinical variable(s) that you are interested in. 
You can use scatterplots or any visualization tool you see fit. 


Next, find a function from an R package that can create a "heat map" and see if 
the features cluster together. Overlay your clustering with a clinical feature. 
Does the clustering of image features seem to correlate with the clinical 
feature?

## Task 3: Survival Information

Fit a Kaplan-Meier survival curve to the time to death and time to recurrence 
data.



