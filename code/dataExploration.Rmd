---
title: "TCIA Data Exploration"
author: "Grant Carr"
date: "`r Sys.Date()`"
output: pdf_document
---

## R Setup

Load packages that are necessary for running all code below.
```{r}
#' example code for installing packages for first time:
#' install.packages("readxl")


library(readxl)
library(tidyverse)
library(ggplot2)
library(survival)
library(ggfortify)
library(devtools)
#' install_github("jokergoo/ComplexHeatmap")
library(ComplexHeatmap)
```


## Reading Clinical Data


```{r}
clinData <- read_xlsx(
  "/Users/grantcarr/Documents/Michigan/BDSI2025/Data/Clinical_and_Other_Features.xlsx", 
  sheet = 1, skip = 1
)
clinData <- clinData[-1,]
```
The '<-' is the assignment operator in R. clinData <- read_xlsx(...) assigns 
the output of read_xlsx() into a variable/object called clinData. Keyboard 
shortcut on a Mac is option, -. You can also use '='. '<-' is used to differentiate 
setting function arguments versus assigning data to a variable.

If you open the dataset, you will see that the first row is variable group 
headings. We want to skip that row when we read the data with the function 
argument "skip = 1".

The second row is treated as the column names and the third row is treated as 
data. In excel, the third row is variable descriptions, not data. So we remove 
the first row with clinData[-1,]. When you are working with 2-dimensional 
datasets/matrix objects, you access rows/columns with clinData[rows, columns]. 
You can pass a vector of numbers to select (or negative numbers to select 
everything except) specific rows/columns of the data.

## Changing Column Names

In the output above, you can see that R changed blank column names to
"...[column number]", and duplicated column names to "[column name]...[column 
number]". Below I manually changed the names of those blank/duplicated column 
names into descriptive column names based on the variable descriptions in 
the excel file.

```{r}
clinData <- clinData %>% rename(
  TumorGradeT = `Tumor Grade`,
  TumorGradeN = ...33,
  TumorGradeM = ...34,
  DiffBilateralReceptors = ...40,
  AnnotatedBilateralSide = ...41,
  OtherBilateralSide = `For Other Side If Bilateral`,
  OtherBilateralOncotype = ...43,
  OtherBilateralGrade = ...44,
  OtherBilateralER = ...45,
  OtherBilateralPR = ...46,
  OtherBilateralHER2 = ...47,
  OtherBilateralSubtype = ...48,
  Shape_mammo = Shape...71,
  Margin_mammo = Margin...72,
  TumorSize_mammo = `Tumor Size (cm)...76`,
  
  Shape_us = Shape...77,
  Margin_us = Margin...78,
  TumorSize_us = `Tumor Size (cm)...79`
) %>% select(-...68)
```

The %>% operator (command, shift, m shortcut on Mac) is from the dplyr package
and means "use the output on the left side as the first argument of the
function on the right". It is useful for sequentially performing multiple 
functions in a single line of code, especially for data formatting.
"select(-...68)" again means that we select every column except for the one 
named "...68".

```{r}
table(clinData$AnnotatedBilateralSide, useNA = "if")
table(clinData$Shape_us, useNA = "if")
table(clinData$`Reconstruction Diameter`, useNA = "if")
```

Tabulating the possible values of the example variables above, we see the labels
"NA", "NC", and "NP". Note that "NA" is the letters "NA", not R's value for NA.
This means that R is treating it as data instead of missing. 

From the excel file, NA means not applicable, NC means not collected, and NP 
means not pertinent. All of these indicate that we don't have the relevant data
for that patient.

Depending on the variable, we may or may not wish to replace "NC" or "NP" with
a missing value, but this is something to keep in mind.

## Reading Image Features
```{r}
imFeatures <- read_xlsx(
  "/Users/grantcarr/Documents/Michigan/BDSI2025/Data/Imaging_Features.xlsx",
  sheet = 1
)
```

In general, the featureCitations.docx file describes the features and provides 
citations. The features are grouped into the categories listed below.

Breast and fibroglandular tissue (FGT) volume features: volume and density of 
breast area and fibroglandular area.

Tumor size and morphology: regularity/roundness vs irregularity of tumor
shape and size.

FGT enhancement: measure how much FGT is enhanced when we add contrast.
This is referred to as BPE, background parenchymal enhancement, which may 
confound tumor enhancement/identification.

Tumor enhancement: measure how much tumor is enhanced when we add contrast

Combining tumor and FGT enhancement: measure how tumor and FGT are 
enhanced when adding contrast

FGT enhancement texture: describe the enhancement due to contrast. Looking at
local patterns, does enhancement look gritty or smooth?

Tumor enhancement texture: same as FGT but for tumor area.

Tumor Enhancement Spatial Heterogeneity: measure similarity between tumor
subregions of the tumor.

FGT enhancement variation: global variation of contrast enhancement of FGT

Tumor enhancement variation: global variation of contrast enhancement of tumor

## Task 1: What is in the data?

How many patients are in the dataset?

```{r}
nrow(clinData)
```

How many missing values are there among image features?
```{r}
sum(is.na(imFeatures))
```

How many missing values are there among clinical features?
```{r}
sum(is.na(clinData))

missingness <- apply(
  clinData, 2, function(x){
    sum(is.na(x))
  }
)
sum(missingness == 0) # there are 86 variables with no missingness
sum(missingness != 0) # the remaining 11 variables have some missing values
missingness[missingness != 0]
```

Some clinical variables have minimal missing values, such as "Contrast Agent" 
(5). Others have so many missing values that the variable is statistically 
useless, such as "Contrast Bolus Volume (mL)" (653).


## Task 2: Visualizing Data

Tabulate some discrete clinical variables and plot some continuous clinical 
variables. Take note of any abnormalities such as missingness, low data 
in a category, or significant skew in continuous variables.

```{r}
apply(clinData, 2, function(x){
  sum(is.na(x)) + sum(x %in% c("NA", "NC", "NP"))
}) %>% table()

sum(is.na(clinData$`Days to MRI (From the Date of Diagnosis)`))
hist(clinData$`Days to MRI (From the Date of Diagnosis)`)
sum(clinData$`Days to MRI (From the Date of Diagnosis)` > 0) # 808
sum(clinData$`Days to MRI (From the Date of Diagnosis)` == 0) # 9
sum(clinData$`Days to MRI (From the Date of Diagnosis)` < 0) # 105

#' everyone gets MRI at different times. knowledge of when other clinical 
#' data is collected may be important in understanding whether
#' image features can reflect relevant information

clinData <- clinData %>% mutate(
  ageAtDiagnosis = -1*as.numeric(`Date of Birth (Days)`)/365
)
hist(clinData$ageAtDiagnosis)
summary(clinData[,"ageAtDiagnosis"])

clinData <- clinData %>% mutate(
  raceEth = case_when(
    `Race and Ethnicity` == 0 ~ NA,
    `Race and Ethnicity` == 1 ~ "White",
    `Race and Ethnicity` == 2 ~ "Black",
    `Race and Ethnicity` == 3 ~ "Asian",
    `Race and Ethnicity` == 4 ~ "Native",
    `Race and Ethnicity` == 5 ~ "Hispanic",
    `Race and Ethnicity` == 6 ~ "Multi",
    `Race and Ethnicity` == 7 ~ "Hawaiian",
    `Race and Ethnicity` == 8 ~ "American Indian",
    .default = "?"
  )
)
table(clinData$raceEth)

clinData <- clinData %>% 
  mutate(
    Subtype = factor(
      case_when(
        `Mol Subtype` == 0 ~ "Luminal",
        `Mol Subtype` == 1 ~ "ER/PR+ and HER2+",
        `Mol Subtype` == 2 ~ "HER2+",
        .default = "Triple Negative"
      ), levels = c("Luminal", "ER/PR+ and HER2+", "HER2+", "Triple Negative")
    )
  )

unique(clinData[clinData$Subtype == "Luminal", c("ER", "PR", "HER2")])
unique(clinData[clinData$Subtype == "ER/PR+ and HER2+", c("ER", "PR", "HER2")])
unique(clinData[clinData$Subtype == "HER2+", c("ER", "PR", "HER2")])
unique(clinData[clinData$Subtype == "Triple Negative", c("ER", "PR", "HER2")])
#' Luminal: at least one ER+/PR+ but not HER2+
#' ER/PR and HER2: HER2+ and at least one ER+/PR+
#' HER2+: HER2+ only
#' triple negative: ER-/PR-/HER2-
table(clinData["Subtype"])
# dominated by luminal subtype, some sparsity in others

table(clinData["Staging(Tumor Size)# [T]"])
# dominated by stage 1/2, sparsity in stages 3/4
table(clinData["Staging(Nodes)#(Nx replaced by -1)[N]"])
# dominated by stage 0/1, sparsity in stages 2/3
table(clinData["Staging(Metastasis)#(Mx -replaced by -1)[M]"])
# dominated by 0 (no mets) and -1 (can't be evaluated)

#' in general, early stage disease

table(clinData["TumorGradeT"], useNA = "if")
table(clinData["TumorGradeN"], useNA = "if")
table(clinData["TumorGradeM"], useNA = "if")
#' very little missingness for tumor grade
#' high Tubule/Nuclear grade, low Mitotic grade

table(clinData["Nottingham grade"], useNA = "if")
table(clinData["Histologic type"], useNA = "if")
#' high degree of missingness in these variables

table(clinData[,"Bilateral Information"])
# lots of missingness, and very few with bilateral disease

table(clinData["Surgery"], useNA = "if")
# nearly all patients had surgery
clinData <- clinData %>% mutate(
  surgeryDays = as.numeric(`Days to Surgery (from the date of diagnosis)`)
)
sum(is.na(clinData["surgeryDays"])) # 47 missing values
sum(complete.cases(clinData[ , c("surgeryDays", "Surgery")]))
# 875 observations for time to surgery
table(clinData["Definitive Surgery Type"], useNA = "if")
# 50/50 BCS vs mastectomy

sum(
  clinData["Neoadjuvant Radiation Therapy"] == 1, na.rm = T
) # 22 patients neoadjuvant radiation therapy (given before surgery)
sum(
  clinData["Adjuvant Radiation Therapy"] == 1, na.rm = T
) # 614 patients adjuvant radiation therapy (given after surgery)

clinData$dead <- ifelse(
  clinData$`Days to death (from the date of diagnosis)` == "NP",
  0, 1
) # if days to death is not pertinent, then they did not die
table(clinData["dead"]) # 62 deaths
clinData$survDays <- ifelse(
  clinData$dead == 1, as.numeric(clinData$`Days to death (from the date of diagnosis)`),
  pmax(
    as.numeric(clinData$`Days to last distant recurrence free assemssment(from the date of diagnosis)`),
    as.numeric(clinData$`Days to last local recurrence free assessment (from the date of diagnosis)`),
    as.numeric(clinData$`Age at last contact in EMR f/u(days)(from the date of diagnosis) ,last time patient known to be alive, unless age of death is reported(in such case the age of death`), na.rm = T
  )
  
)
#' if dead, then use days to death
#' if they did not die, then use the last time we know any information
#' about them being alive. pmax = parallel maximum of vectors, pmax of 
#' last local recurrence free assessment, last distant recurrence free 
#' assessment, and last contact in electronic medical record
summary(clinData["survDays"]/365) # IQR 2.8-5.2, median 4 years
hist(unlist(clinData["survDays"]))
sum(complete.cases(clinData[ , c("survDays", "dead")]))
# 922 observations for time to death

clinData$recurrence <- as.numeric(clinData$`Recurrence event(s)`)
#' make recurrence a numeric indicator
table(clinData["recurrence"], useNA = "if") # 87 recurrence, 2 missing
clinData$recurDays <- ifelse(
  clinData$recurrence == 0, as.numeric(clinData$survDays),
  ifelse(
    clinData$recurrence == 1,
    pmin(
    as.numeric(clinData$`Days to distant recurrence(from the date of diagnosis)`),
    as.numeric(clinData$`Days to local recurrence (from the date of diagnosis)`),
    na.rm = T
  ),
    NA
  )
  
)
#' if no recurrence, then days to recurrence is just survival days
#' if recurrence, then days to recurrence is minimum of days to local 
#' recurrence and days to distant recurrence
#' if recurrence is missing, then days to recurrence is missing
hist(unlist(clinData["recurDays"]))
sum(complete.cases(clinData[ , c("recurDays", "recurrence")]))
# 920 observations for time to recurrence

table(clinData[ , "Neoadjuvant Chemotherapy"])
table(clinData[ , "Adjuvant Chemotherapy"])
# many with neoadjuvant or adjuvant chemotherapy

table(clinData[ , "Neoadjuvant Anti-Her2 Neu Therapy"], useNA = "if")
table(clinData[ , "Adjuvant Anti-Her2 Neu Therapy"], useNA = "if")
# few with neoadjuvant or adjuvant anti-Her2

table(clinData[,"Received Neoadjuvant Therapy or Not"], useNA = "if")
# overall, most patients did not receive any type of neoadjuvant therapy
```


Pick a group of image features as they are grouped in the 
featureDocumentation.docx file. Explore whether there is an association between 
the image feature(s) and any clinical variable(s) that you are interested in. 
You can use scatterplots or any visualization tool you see fit. 
```{r}
#' I am interested in tumor enhancement texture and its relationship
#' to tumor subtype
tumorEnhanceTexture_vars <- colnames(imFeatures)[
  c(189:232, 279:281, 287:308, 313:334, 339:360, 27:48)
]
# manually identify all variables in the tumor enhancement texture group, 
# 135 of them

fullData <- left_join(
  clinData, imFeatures
)

subData <- fullData %>% 
  select(Subtype, all_of(tumorEnhanceTexture_vars))
ggplot(
  subData, 
  aes(x = Subtype, y = `1st_DFT_CoeffMap_Momment_Invariant_1_3D_tumor`)
) +
  geom_boxplot()
ggplot(
  subData, 
  aes(x = Subtype, y = SER_map_Autocorrelation_tumor)
) +
  geom_boxplot()
ggplot(
  subData, 
  aes(x = Subtype, y = SER_map_Correlation1_tumor)
) +
  geom_boxplot()


```

Next, find a function from an R package that can create a "heat map" and see if 
the features cluster together. Overlay your clustering with a clinical feature. 
Does the clustering of image features seem to correlate with the clinical 
feature?

```{r}
heatMatrix <- scale(subData[,-1])

row_ha <- rowAnnotation(Subtype = subData$Subtype)
Heatmap(
  heatMatrix, column_labels = rep("", ncol(heatMatrix)),
  right_annotation = row_ha
)

row_ha_her2 <- rowAnnotation(HER2 = ifelse(fullData$HER2 == 1, "HER2+", "HER2-"))
Heatmap(
  heatMatrix, column_labels = rep("", ncol(heatMatrix)),
  right_annotation = row_ha_her2
)

row_ha_surv <- rowAnnotation(Survival = fullData$survDays)
Heatmap(
  heatMatrix, column_labels = rep("", ncol(heatMatrix)),
  right_annotation = row_ha_surv
)

```

Heat maps can be a useful tool for finding broad patterns in data. 
In the above example, there may be some clustering of textural features, but 
the clustering does not correspond to any clinical outcomes. Clustering 
does not provide rigorous statistical evidence of associations, 
but it can be a useful exploratory step.

## Task 3: Survival Information

Fit a Kaplan-Meier survival curve to the time to death and time to recurrence 
data.

```{r}
deathFit <- survfit(Surv(survDays, dead) ~ 1, data = clinData)
autoplot(deathFit) +
  labs(title = "Kaplan-Meier Survival Curve, Time to Death",
       x = "Days", y = "Survival")

recurFit <- survfit(Surv(recurDays, recurrence) ~ 1, data = clinData)
autoplot(recurFit) +
  labs(title = "Kaplan-Meier Survival Curve, Time to First Recurrence",
       x = "Days", y = "Survival")

clinData <- clinData %>% 
  mutate(
    Subtype = factor(
      case_when(
        `Mol Subtype` == 0 ~ "Luminal",
        `Mol Subtype` == 1 ~ "ER/PR+ and HER2+",
        `Mol Subtype` == 2 ~ "HER2+",
        .default = "Triple Negative"
      ), levels = c("Luminal", "ER/PR+ and HER2+", "HER2+", "Triple Negative")
    )
  )

autoplot(update(deathFit, .~.+Subtype)) +
  labs(title = "Kaplan-Meier Survival Curve, Time to Death by Subtype",
       x = "Days", y = "Survival", col = "Subtype", fill = "Subtype")
autoplot(update(recurFit, .~.+Subtype)) +
  labs(title = "Kaplan-Meier Survival Curve, Time to Recurrence by Subtype",
       x = "Days", y = "Survival", col = "Subtype", fill = "Subtype")
```











